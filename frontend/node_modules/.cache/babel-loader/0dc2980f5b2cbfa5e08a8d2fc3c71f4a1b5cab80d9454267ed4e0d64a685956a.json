{"ast":null,"code":"import{useState,useEffect,useCallback}from'react';import{useMutation,useQuery,useApolloClient}from'@apollo/client/react';import{LOGIN,REGISTER,LOGOUT,REFRESH_TOKEN}from'../graphql/mutations';import{GET_ME}from'../graphql/queries';import{setAuthToken,clearAuthToken,isAuthenticated}from'../lib/apollo';export function useAuth(){const client=useApolloClient();const[user,setUser]=useState(null);const[loading,setLoading]=useState(true);const[error,setError]=useState(null);// Type for GET_ME query result\n// Query for current user\nconst{data:meData,loading:meLoading,refetch:refetchMe,error:meError}=useQuery(GET_ME,{skip:!isAuthenticated()});// Handle query result changes\nuseEffect(()=>{if(meData!==null&&meData!==void 0&&meData.me){setUser(meData.me);localStorage.setItem('user',JSON.stringify(meData.me));}if(meError){// Token might be invalid, clear it\nclearAuthToken();setUser(null);}},[meData,meError]);// Login mutation\nconst[loginMutation,{loading:loginLoading}]=useMutation(LOGIN,{onCompleted:data=>{const{token,refreshToken,user}=data.login;setAuthToken(token,refreshToken);setUser(user);localStorage.setItem('user',JSON.stringify(user));setError(null);},onError:err=>{setError(err.message);}});// Register mutation\nconst[registerMutation,{loading:registerLoading}]=useMutation(REGISTER,{onCompleted:data=>{const{token,refreshToken,user}=data.register;setAuthToken(token,refreshToken);setUser(user);localStorage.setItem('user',JSON.stringify(user));setError(null);},onError:err=>{setError(err.message);}});// Logout mutation\nconst[logoutMutation]=useMutation(LOGOUT,{onCompleted:()=>{clearAuthToken();setUser(null);client.resetStore();}});// Refresh token mutation\nconst[refreshTokenMutation]=useMutation(REFRESH_TOKEN);// Initialize auth state\nuseEffect(()=>{const initAuth=async()=>{if(isAuthenticated()){// Try to get user from localStorage first for faster load\nconst savedUser=localStorage.getItem('user');if(savedUser){try{setUser(JSON.parse(savedUser));}catch(_unused){// Invalid saved user, will refetch\n}}// Then verify with server\ntry{await refetchMe();}catch(_unused2){// If fetch fails, we might be offline\n// Keep the user from localStorage\n}}setLoading(false);};initAuth();},[refetchMe]);// Login function\nconst login=useCallback(async(email,password)=>{var _result$data;const result=await loginMutation({variables:{input:{email,password}}});return(_result$data=result.data)===null||_result$data===void 0?void 0:_result$data.login;},[loginMutation]);// Register function\nconst register=useCallback(async(email,password,name)=>{var _result$data2;const result=await registerMutation({variables:{input:{email,password,name}}});return(_result$data2=result.data)===null||_result$data2===void 0?void 0:_result$data2.register;},[registerMutation]);// Logout function\nconst logout=useCallback(async()=>{await logoutMutation();},[logoutMutation]);// Refresh token function\nconst refreshAuthToken=useCallback(async()=>{var _result$data3;const refreshToken=localStorage.getItem('refreshToken');if(!refreshToken){throw new Error('No refresh token available');}const result=await refreshTokenMutation({variables:{token:refreshToken}});if((_result$data3=result.data)!==null&&_result$data3!==void 0&&_result$data3.refreshToken){const{token,refreshToken:newRefreshToken,user}=result.data.refreshToken;setAuthToken(token,newRefreshToken);setUser(user);return token;}throw new Error('Failed to refresh token');},[refreshTokenMutation]);return{user,loading:loading||meLoading,loginLoading,registerLoading,error,isAuthenticated:!!user,login,register,logout,refreshAuthToken,clearError:()=>setError(null)};}export function useRequireAuth(){let redirectUrl=arguments.length>0&&arguments[0]!==undefined?arguments[0]:'/login';const{user,loading,isAuthenticated}=useAuth();useEffect(()=>{if(!loading&&!isAuthenticated){window.location.href=redirectUrl;}},[loading,isAuthenticated,redirectUrl]);return{user,loading,isAuthenticated};}","map":{"version":3,"names":["useState","useEffect","useCallback","useMutation","useQuery","useApolloClient","LOGIN","REGISTER","LOGOUT","REFRESH_TOKEN","GET_ME","setAuthToken","clearAuthToken","isAuthenticated","useAuth","client","user","setUser","loading","setLoading","error","setError","data","meData","meLoading","refetch","refetchMe","meError","skip","me","localStorage","setItem","JSON","stringify","loginMutation","loginLoading","onCompleted","token","refreshToken","login","onError","err","message","registerMutation","registerLoading","register","logoutMutation","resetStore","refreshTokenMutation","initAuth","savedUser","getItem","parse","_unused","_unused2","email","password","_result$data","result","variables","input","name","_result$data2","logout","refreshAuthToken","_result$data3","Error","newRefreshToken","clearError","useRequireAuth","redirectUrl","arguments","length","undefined","window","location","href"],"sources":["/home/zobair-qauomi/todo_app/frontend/src/hooks/useAuth.ts"],"sourcesContent":["import { useState, useEffect, useCallback } from 'react';\nimport { useMutation, useQuery, useApolloClient } from '@apollo/client/react';\nimport { LOGIN, REGISTER, LOGOUT, REFRESH_TOKEN } from '../graphql/mutations';\nimport { GET_ME } from '../graphql/queries';\nimport { setAuthToken, clearAuthToken, isAuthenticated, getAuthToken } from '../lib/apollo';\n\nexport interface User {\n  id: string;\n  email: string;\n  name?: string;\n  avatar?: string;\n  createdAt: string;\n  lastLoginAt?: string;\n}\n\ninterface AuthPayload {\n  token: string;\n  refreshToken: string;\n  user: User;\n}\n\ninterface LoginInput {\n  email: string;\n  password: string;\n}\n\ninterface RegisterInput {\n  email: string;\n  password: string;\n  name?: string;\n}\n\nexport function useAuth() {\n  const client = useApolloClient();\n  const [user, setUser] = useState<User | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n\n  // Type for GET_ME query result\n  interface MeQueryResult {\n    me: User;\n  }\n\n  // Query for current user\n  const { data: meData, loading: meLoading, refetch: refetchMe, error: meError } = useQuery<MeQueryResult>(GET_ME, {\n    skip: !isAuthenticated(),\n  });\n\n  // Handle query result changes\n  useEffect(() => {\n    if (meData?.me) {\n      setUser(meData.me);\n      localStorage.setItem('user', JSON.stringify(meData.me));\n    }\n    if (meError) {\n      // Token might be invalid, clear it\n      clearAuthToken();\n      setUser(null);\n    }\n  }, [meData, meError]);\n\n  // Login mutation\n  const [loginMutation, { loading: loginLoading }] = useMutation<{ login: AuthPayload }, { input: LoginInput }>(LOGIN, {\n    onCompleted: (data) => {\n      const { token, refreshToken, user } = data.login;\n      setAuthToken(token, refreshToken);\n      setUser(user);\n      localStorage.setItem('user', JSON.stringify(user));\n      setError(null);\n    },\n    onError: (err) => {\n      setError(err.message);\n    },\n  });\n\n  // Register mutation\n  const [registerMutation, { loading: registerLoading }] = useMutation<{ register: AuthPayload }, { input: RegisterInput }>(REGISTER, {\n    onCompleted: (data) => {\n      const { token, refreshToken, user } = data.register;\n      setAuthToken(token, refreshToken);\n      setUser(user);\n      localStorage.setItem('user', JSON.stringify(user));\n      setError(null);\n    },\n    onError: (err) => {\n      setError(err.message);\n    },\n  });\n\n  // Logout mutation\n  const [logoutMutation] = useMutation(LOGOUT, {\n    onCompleted: () => {\n      clearAuthToken();\n      setUser(null);\n      client.resetStore();\n    },\n  });\n\n  // Refresh token mutation\n  const [refreshTokenMutation] = useMutation<{ refreshToken: AuthPayload }, { token: string }>(REFRESH_TOKEN);\n\n  // Initialize auth state\n  useEffect(() => {\n    const initAuth = async () => {\n      if (isAuthenticated()) {\n        // Try to get user from localStorage first for faster load\n        const savedUser = localStorage.getItem('user');\n        if (savedUser) {\n          try {\n            setUser(JSON.parse(savedUser));\n          } catch {\n            // Invalid saved user, will refetch\n          }\n        }\n\n        // Then verify with server\n        try {\n          await refetchMe();\n        } catch {\n          // If fetch fails, we might be offline\n          // Keep the user from localStorage\n        }\n      }\n      setLoading(false);\n    };\n\n    initAuth();\n  }, [refetchMe]);\n\n  // Login function\n  const login = useCallback(async (email: string, password: string) => {\n    const result = await loginMutation({\n      variables: { input: { email, password } },\n    });\n    return result.data?.login;\n  }, [loginMutation]);\n\n  // Register function\n  const register = useCallback(async (email: string, password: string, name?: string) => {\n    const result = await registerMutation({\n      variables: { input: { email, password, name } },\n    });\n    return result.data?.register;\n  }, [registerMutation]);\n\n  // Logout function\n  const logout = useCallback(async () => {\n    await logoutMutation();\n  }, [logoutMutation]);\n\n  // Refresh token function\n  const refreshAuthToken = useCallback(async () => {\n    const refreshToken = localStorage.getItem('refreshToken');\n    if (!refreshToken) {\n      throw new Error('No refresh token available');\n    }\n\n    const result = await refreshTokenMutation({\n      variables: { token: refreshToken },\n    });\n\n    if (result.data?.refreshToken) {\n      const { token, refreshToken: newRefreshToken, user } = result.data.refreshToken;\n      setAuthToken(token, newRefreshToken);\n      setUser(user);\n      return token;\n    }\n\n    throw new Error('Failed to refresh token');\n  }, [refreshTokenMutation]);\n\n  return {\n    user,\n    loading: loading || meLoading,\n    loginLoading,\n    registerLoading,\n    error,\n    isAuthenticated: !!user,\n    login,\n    register,\n    logout,\n    refreshAuthToken,\n    clearError: () => setError(null),\n  };\n}\n\nexport function useRequireAuth(redirectUrl = '/login') {\n  const { user, loading, isAuthenticated } = useAuth();\n\n  useEffect(() => {\n    if (!loading && !isAuthenticated) {\n      window.location.href = redirectUrl;\n    }\n  }, [loading, isAuthenticated, redirectUrl]);\n\n  return { user, loading, isAuthenticated };\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}